{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/patrimoine-analyzer/manifest.schema.json",
  "title": "Patrimoine Analyzer Manifest v2.1",
  "description": "Schéma de validation pour manifest.json (v2.1) - Architecture homogène avec custodian unifié et sections manuelles",
  "type": "object",
  "required": ["version", "profil_investisseur", "patrimoine"],
  "properties": {
    "version": {
      "description": "Version du schéma manifest",
      "type": "string",
      "pattern": "^2\\.(0|1)\\.\\d+$",
      "examples": ["2.1.0", "2.0.0"]
    },
    "generated_at": {
      "description": "Date de génération du manifest (ISO 8601)",
      "type": "string",
      "format": "date-time"
    },
    "profil_investisseur": {
      "description": "Profil complet de l'investisseur",
      "type": "object",
      "required": ["identite", "professionnel", "investissement"],
      "properties": {
        "identite": {
          "type": "object",
          "properties": {
            "prenom": { "type": "string", "minLength": 1 },
            "nom": { "type": "string", "minLength": 1 },
            "genre": { "type": "string", "enum": ["Homme", "Femme", "Autre"] },
            "date_naissance": {
              "type": "string",
              "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
              "description": "Format: YYYY-MM-DD"
            },
            "situation_familiale": {
              "type": "string",
              "enum": [
                "Célibataire",
                "Marié",
                "Marié(e)",
                "Pacsé(e)",
                "Divorcé(e)",
                "Veuf(ve)",
                "Union libre"
              ]
            },
            "enfants": { "type": "integer", "minimum": 0, "maximum": 20 }
          },
          "additionalProperties": true
        },
        "professionnel": {
          "type": "object",
          "properties": {
            "statut": {
              "type": "string",
              "enum": [
                "Actif",
                "Salarié",
                "Fonctionnaire",
                "Indépendant",
                "Chef d'entreprise",
                "Retraité",
                "Étudiant",
                "Sans emploi"
              ]
            },
            "profession": { "type": "string", "minLength": 1 },
            "revenu_mensuel_net": {
              "type": "integer",
              "minimum": 0,
              "description": "Revenu mensuel net en euros"
            }
          },
          "additionalProperties": true
        },
        "investissement": {
          "type": "object",
          "required": ["profil_risque"],
          "properties": {
            "profil_risque": {
              "type": "string",
              "enum": ["dynamique", "equilibre", "prudent", "default"],
              "description": "Profil de risque (source de vérité v2.1)"
            },
            "horizon": {
              "type": "string",
              "enum": ["court_terme", "moyen_terme", "long_terme"]
            },
            "objectifs": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": [
                  "croissance",
                  "revenus",
                  "preservation_capital",
                  "retraite",
                  "transmission",
                  "projet_immobilier"
                ]
              },
              "uniqueItems": true
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "patrimoine": {
      "description": "Ensemble des actifs du patrimoine (v2.1)",
      "type": "object",
      "properties": {
        "comptes_titres": {
          "description": "Comptes titres à parser (PEA, CTO, AV, PER, etc.)",
          "type": "array",
          "items": {
            "$ref": "#/definitions/compte_avec_parser"
          }
        },
        "liquidites": {
          "description": "Comptes de liquidités (saisie manuelle)",
          "type": "array",
          "items": {
            "$ref": "#/definitions/actif_manuel"
          }
        },
        "obligations": {
          "description": "Obligations (T-Bonds, etc.)",
          "type": "array",
          "items": {
            "$ref": "#/definitions/obligation"
          }
        },
        "crypto": {
          "description": "Cryptomonnaies (custodial, self-custody, DeFi)",
          "type": "array",
          "items": {
            "$ref": "#/definitions/actif_crypto"
          }
        },
        "metaux_precieux": {
          "description": "Métaux précieux (or, argent, platine)",
          "type": "array",
          "items": {
            "$ref": "#/definitions/actif_manuel"
          }
        },
        "immobilier": {
          "description": "Biens immobiliers",
          "type": "array",
          "items": {
            "$ref": "#/definitions/bien_immobilier"
          }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "definitions": {
    "compte_avec_parser": {
      "type": "object",
      "required": [
        "id",
        "custodian",
        "custodian_name",
        "custody_type",
        "type_compte",
        "source_file",
        "parser_strategy"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9_]+$",
          "description": "Identifiant unique (format: {custodian}_{type}_{seq})",
          "examples": ["ca_pea_001", "dgo_cto_005"]
        },
        "custodian": {
          "type": "string",
          "pattern": "^[a-z_]+$",
          "description": "Code custodian normalisé (snake_case)",
          "examples": ["credit_agricole", "boursobank", "degiro"]
        },
        "custodian_name": {
          "type": "string",
          "description": "Nom complet lisible du custodian",
          "examples": ["Crédit Agricole", "BoursoBank", "Degiro"]
        },
        "custody_type": {
          "type": "string",
          "enum": [
            "institutional",
            "custodial_platform",
            "self_custody",
            "defi",
            "direct_ownership"
          ],
          "description": "Type de garde"
        },
        "type_compte": {
          "type": "string",
          "description": "Type de compte",
          "examples": ["PEA", "PEA-PME", "Assurance-vie", "CTO", "PER"]
        },
        "source_file": {
          "type": "string",
          "pattern": "\\.(csv|pdf|json)$",
          "description": "Fichier source à parser",
          "examples": ["[CA] - PEA.pdf", "[DGO] - CTO.csv"]
        },
        "parser_strategy": {
          "type": "string",
          "pattern": "^[a-z_]+\\.[a-z_]+\\.[a-z0-9_]+$",
          "description": "Stratégie de parsing (format: namespace.type.version)",
          "examples": ["credit_agricole.pea.v2025", "generic.csv.flexible"]
        },
        "fallback_parsers": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z_]+\\.[a-z_]+\\.[a-z0-9_]+$"
          },
          "description": "Parsers de fallback",
          "uniqueItems": true
        },
        "metadata": {
          "type": "object",
          "description": "Métadonnées optionnelles",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "actif_manuel": {
      "type": "object",
      "required": [
        "id",
        "custodian",
        "custodian_name",
        "custody_type",
        "type_compte",
        "currency",
        "montant"
      ],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9_]+$" },
        "custodian": { "type": "string", "pattern": "^[a-z_]+$" },
        "custodian_name": { "type": "string" },
        "custody_type": {
          "type": "string",
          "enum": [
            "institutional",
            "custodial_platform",
            "self_custody",
            "direct_ownership"
          ]
        },
        "type_compte": { "type": "string" },
        "type_actif": { "type": "string" },
        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "examples": ["EUR", "USD"]
        },
        "montant": { "type": "number", "minimum": 0 },
        "montant_eur_equivalent": { "type": "number", "minimum": 0 },
        "metadata": {
          "type": "object",
          "description": "Métadonnées optionnelles pour enrichir les données",
          "properties": {
            "juridiction": {
              "type": "string",
              "description": "Juridiction principale de l'établissement",
              "examples": ["France", "Suisse", "Luxembourg", "Pays-Bas", "États-Unis"]
            },
            "juridiction_pays": {
              "type": "string",
              "description": "Pays ISO 3166",
              "examples": ["France", "Suisse", "Luxembourg", "Pays-Bas", "États-Unis"]
            },
            "garantie_depots": {
              "type": "string",
              "description": "Garantie des dépôts applicable",
              "examples": ["100000 EUR (FGDR)", "100000 CHF (esisuisse)", "N/A"]
            },
            "exposition_sapin_2": {
              "type": "string",
              "enum": ["OUI", "NON"],
              "description": "Exposition à la loi Sapin 2 (France)"
            },
            "exposition_risque_france": {
              "type": "string",
              "enum": ["FAIBLE", "MOYENNE", "ELEVEE"],
              "description": "Niveau d'exposition au risque France"
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "obligation": {
      "type": "object",
      "required": [
        "id",
        "custodian",
        "custodian_name",
        "custody_type",
        "type_actif",
        "comptes"
      ],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9_]+$" },
        "custodian": { "type": "string", "pattern": "^[a-z_]+$" },
        "custodian_name": { "type": "string" },
        "custody_type": {
          "type": "string",
          "enum": ["custodial_platform", "institutional"]
        },
        "type_actif": {
          "type": "string",
          "examples": ["T-Bonds", "Obligations d'État"]
        },
        "comptes": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["currency", "montant"],
            "properties": {
              "currency": { "type": "string", "pattern": "^[A-Z]{3}$" },
              "montant": { "type": "number", "minimum": 0 },
              "montant_eur_equivalent": { "type": "number", "minimum": 0 }
            }
          }
        }
      },
      "additionalProperties": false
    },
    "actif_crypto": {
      "type": "object",
      "required": [
        "id",
        "custodian",
        "custodian_name",
        "custody_type",
        "type_actif",
        "currency"
      ],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9_]+$" },
        "custodian": { "type": "string", "pattern": "^[a-z_]+$" },
        "custodian_name": { "type": "string" },
        "custody_type": {
          "type": "string",
          "enum": ["custodial_platform", "self_custody", "defi"]
        },
        "type_actif": {
          "type": "string",
          "examples": ["BTC", "Crypto multi-actifs"]
        },
        "currency": { "type": "string", "pattern": "^[A-Z]{3}$" },
        "montant": { "type": "number", "minimum": 0 },
        "montant_eur_equivalent": { "type": "number", "minimum": 0 },
        "source_file": { "type": "string", "pattern": "\\.(csv|pdf|json)$" },
        "parser_strategy": { "type": "string" },
        "metadata": {
          "type": "object",
          "description": "Métadonnées optionnelles pour enrichir les données crypto",
          "properties": {
            "juridiction": {
              "type": "string",
              "description": "Juridiction principale de la plateforme/custodian",
              "examples": ["France", "États-Unis", "Suisse", "N/A (self-custody)"]
            },
            "juridiction_pays": {
              "type": "string",
              "description": "Pays ISO 3166 (N/A pour self-custody/DeFi)",
              "examples": ["France", "États-Unis", "Suisse", "N/A"]
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "bien_immobilier": {
      "type": "object",
      "required": [
        "id",
        "custodian",
        "custodian_name",
        "custody_type",
        "type_bien",
        "adresse",
        "currency"
      ],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9_]+$" },
        "custodian": { "type": "string", "pattern": "^[a-z_]+$" },
        "custodian_name": { "type": "string" },
        "custody_type": { "type": "string", "enum": ["direct_ownership"] },
        "type_bien": {
          "type": "string",
          "examples": ["Appartement", "Maison", "Studio", "SCPI"]
        },
        "adresse": { "type": "string" },
        "surface_m2": { "type": "number", "minimum": 0 },
        "prix_acquisition": { "type": "number", "minimum": 0 },
        "valeur_actuelle": { "type": "number", "minimum": 0 },
        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "default": "EUR"
        },
        "metadata": {
          "type": "object",
          "description": "Métadonnées optionnelles pour enrichir les données immobilières",
          "properties": {
            "juridiction": {
              "type": "string",
              "description": "Juridiction/pays où se situe le bien",
              "examples": ["France", "Suisse", "Portugal", "Espagne"]
            },
            "juridiction_pays": {
              "type": "string",
              "description": "Pays ISO 3166",
              "examples": ["France", "Suisse", "Portugal", "Espagne"]
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    }
  }
}
