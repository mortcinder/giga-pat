{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/patrimoine-analyzer/manifest.schema.json",
  "title": "Patrimoine Analyzer Manifest",
  "description": "Schéma de validation pour manifest.json (v2.0) - Point d'entrée unique pour définir profil investisseur et comptes",
  "type": "object",
  "required": ["version", "profil_investisseur", "comptes"],
  "properties": {
    "version": {
      "description": "Version du schéma manifest",
      "type": "string",
      "pattern": "^2\\.0\\.\\d+$",
      "examples": ["2.0.0"]
    },
    "generated_at": {
      "description": "Date de génération du manifest (ISO 8601)",
      "type": "string",
      "format": "date-time"
    },
    "profil_investisseur": {
      "description": "Profil complet de l'investisseur",
      "type": "object",
      "required": ["identite", "professionnel", "investissement"],
      "properties": {
        "identite": {
          "type": "object",
          "properties": {
            "prenom": {
              "type": "string",
              "minLength": 1
            },
            "nom": {
              "type": "string",
              "minLength": 1
            },
            "genre": {
              "type": "string",
              "enum": ["Homme", "Femme", "Autre"]
            },
            "date_naissance": {
              "type": "string",
              "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
              "description": "Format: YYYY-MM-DD"
            },
            "situation_familiale": {
              "type": "string",
              "enum": ["Célibataire", "Marié(e)", "Pacsé(e)", "Divorcé(e)", "Veuf(ve)", "Union libre"]
            },
            "enfants": {
              "type": "integer",
              "minimum": 0,
              "maximum": 20
            }
          },
          "additionalProperties": true
        },
        "professionnel": {
          "type": "object",
          "properties": {
            "statut": {
              "type": "string",
              "enum": ["Salarié", "Fonctionnaire", "Indépendant", "Chef d'entreprise", "Retraité", "Étudiant", "Sans emploi"]
            },
            "profession": {
              "type": "string",
              "minLength": 1
            },
            "revenu_mensuel_net": {
              "type": "integer",
              "minimum": 0,
              "description": "Revenu mensuel net en euros"
            }
          },
          "additionalProperties": true
        },
        "investissement": {
          "type": "object",
          "required": ["profil_risque"],
          "properties": {
            "profil_risque": {
              "type": "string",
              "enum": ["dynamique", "equilibre", "prudent", "default"],
              "description": "Profil de risque utilisé pour l'analyse (source de vérité v2.0)"
            },
            "horizon": {
              "type": "string",
              "enum": ["court_terme", "moyen_terme", "long_terme"]
            },
            "objectifs": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["croissance", "revenus", "preservation_capital", "retraite", "transmission", "projet_immobilier"]
              },
              "uniqueItems": true
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "comptes": {
      "description": "Liste des comptes financiers à parser",
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "etablissement", "type_compte", "source_file", "parser_strategy"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_]+$",
            "description": "Identifiant unique du compte (snake_case)",
            "examples": ["ca_pea_001", "dgo_cto_001"]
          },
          "etablissement": {
            "type": "string",
            "pattern": "^[a-z_]+$",
            "description": "Code établissement normalisé (snake_case)",
            "examples": ["credit_agricole", "boursobank", "degiro"]
          },
          "type_compte": {
            "type": "string",
            "description": "Type de compte",
            "examples": ["PEA", "PEA-PME", "Assurance-vie", "CTO", "PER", "Livret"]
          },
          "source_file": {
            "type": "string",
            "pattern": "\\.(csv|pdf|json)$",
            "description": "Nom du fichier source (doit exister dans sources/)",
            "examples": ["[CA] - PEA.pdf", "[DGO] - CTO.csv"]
          },
          "parser_strategy": {
            "type": "string",
            "pattern": "^[a-z_]+\\.[a-z_]+\\.[a-z0-9_]+$",
            "description": "Stratégie de parsing (format: etablissement.type.version)",
            "examples": ["credit_agricole.pea.v2025", "generic.csv.flexible"]
          },
          "fallback_parsers": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^[a-z_]+\\.[a-z_]+\\.[a-z0-9_]+$"
            },
            "description": "Parsers de fallback (essayés si parser_strategy échoue)",
            "uniqueItems": true
          },
          "metadata": {
            "type": "object",
            "description": "Métadonnées optionnelles pour le parsing",
            "properties": {
              "date_releve": {
                "type": "string",
                "format": "date"
              },
              "format_version": {
                "type": "string"
              },
              "checksum": {
                "type": "string"
              }
            },
            "additionalProperties": true
          }
        },
        "additionalProperties": false
      }
    },
    "crypto": {
      "description": "Comptes crypto (optionnel)",
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "plateforme", "source_file"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_]+$"
          },
          "plateforme": {
            "type": "string",
            "examples": ["ledger", "bitstack", "aave"]
          },
          "source_file": {
            "type": "string"
          },
          "parser_strategy": {
            "type": "string"
          }
        }
      }
    },
    "immobilier": {
      "description": "Biens immobiliers (optionnel)",
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "type", "source_file"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_]+$"
          },
          "type": {
            "type": "string",
            "enum": ["Résidence principale", "Résidence secondaire", "Investissement locatif", "SCPI"]
          },
          "source_file": {
            "type": "string"
          }
        }
      }
    }
  },
  "additionalProperties": false
}
